[
  [
    {
      "$unwind": {
        "path": "$accounts",
        "preserveNullAndEmptyArrays": false
      }
    },
    {
      "$lookup": {
        "from": "accounts",
        "localField": "accounts",
        "foreignField": "account_id",
        "as": "result"
      }
    },
    {
      "$unwind": {
        "path": "$result",
        "preserveNullAndEmptyArrays": false
      }
    },
    {
      "$unwind": {
        "path": "$result.products",
        "preserveNullAndEmptyArrays": false
      }
    },
    {
      "$group": {
        "_id": "$result.products",
        "avglimit": {
          "$avg": "$result.limit"
        },
        "count": {
          "$sum": 1
        }
      }
    }
  ],
  [
    {
      "$group": {
        "_id": "$result.products",
        "avglimit": {
          "$avg": "$result.limit"
        },
        "count": {
          "$sum": 1
        }
      }
    }
  ]
]